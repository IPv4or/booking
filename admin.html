<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erthaware | Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400..800&family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Space Grotesk', sans-serif;
            color: #2D3436;
            background-color: #F8F6F2;
        }
        .font-display {
            font-family: 'Syne', sans-serif;
            font-weight: 800;
            text-transform: uppercase;
        }
        .action-btn {
            transition: all 0.2s ease;
            box-shadow: 3px 3px 0px 0px #2D3436;
            border: 2px solid #2D3436;
        }
        .action-btn:hover {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0px 0px #2D3436;
        }
        .action-btn:active {
            transform: translate(3px, 3px);
            box-shadow: 0px 0px 0px 0px #2D3436;
        }
        .calendar-day.selected {
            background-color: #A3B18A;
            color: #2D3436;
            font-weight: bold;
        }
    </style>
</head>
<body class="antialiased">

    <header class="bg-white/80 backdrop-blur-sm border-b border-slate-200">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div>
                <h1 class="font-display text-3xl text-[#4B5320]">Admin Dashboard</h1>
                <p class="text-slate-600">Manage bookings and availability.</p>
            </div>
            <button id="logoutBtn" class="action-btn bg-red-500 text-white px-4 py-2 rounded-lg font-bold text-sm">Logout</button>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Bookings List (takes 2 columns on large screens) -->
            <div class="lg:col-span-2">
                <h2 class="font-display text-2xl text-[#3A5A40] mb-4">Scheduled Pickups</h2>
                <div id="bookingsList" class="space-y-6">
                    <p class="text-slate-500">Loading bookings...</p>
                </div>
            </div>

            <!-- Availability Manager -->
            <div>
                <h2 class="font-display text-2xl text-[#3A5A40] mb-4">Manage Availability</h2>
                 <div class="bg-white/70 p-4 rounded-lg border">
                    <div class="flex items-center justify-between mb-4">
                        <button id="prevMonth" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <h3 id="monthYear" class="font-bold text-lg"></h3>
                        <button id="nextMonth" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-center">
                        <!-- Calendar will be rendered here -->
                    </div>
                </div>
                <div id="availabilityEditor" class="mt-4 bg-white/70 p-4 rounded-lg border hidden">
                    <h3 class="font-bold mb-3">Edit slots for <span id="editingDate"></span>:</h3>
                    <div id="timeSlotsCheckboxes" class="space-y-2">
                        <!-- Checkboxes will be rendered here -->
                    </div>
                    <button id="saveAvailability" class="mt-4 action-btn w-full bg-[#D97706] text-white p-2 rounded-lg font-bold">
                        Save Availability
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'http://localhost:3000';
            const token = sessionStorage.getItem('erthaware-admin-token');

            // --- SECURITY CHECK ---
            if (!token) {
                window.location.href = './login.html';
                return; // Stop script execution if not authenticated
            }

            const authHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };

            // --- STATE ---
            let currentDate = new Date();
            let selectedDate = null;
            let availabilityData = {};

            // --- DOM ELEMENTS ---
            const bookingsListEl = document.getElementById('bookingsList');
            const monthYearEl = document.getElementById('monthYear');
            const calendarGridEl = document.getElementById('calendarGrid');
            const prevMonthBtn = document.getElementById('prevMonth');
            const nextMonthBtn = document.getElementById('nextMonth');
            const availabilityEditorEl = document.getElementById('availabilityEditor');
            const editingDateEl = document.getElementById('editingDate');
            const timeSlotsCheckboxesEl = document.getElementById('timeSlotsCheckboxes');
            const saveAvailabilityBtn = document.getElementById('saveAvailability');
            const logoutBtn = document.getElementById('logoutBtn');


            // --- DATA FETCHING ---
            async function fetchWithAuth(url, options = {}) {
                const response = await fetch(url, { ...options, headers: { ...options.headers, ...authHeaders } });
                if (response.status === 401 || response.status === 403) {
                    sessionStorage.removeItem('erthaware-admin-token');
                    window.location.href = './login.html';
                    throw new Error('Authentication failed');
                }
                if (!response.ok) {
                    throw new Error('An API error occurred');
                }
                return response.json();
            }

            async function fetchBookings() {
                try {
                    const bookings = await fetchWithAuth(`${API_BASE_URL}/api/admin/bookings`);
                    renderBookings(bookings);
                } catch (error) {
                    bookingsListEl.innerHTML = `<p class="text-red-500">${error.message}. Please log in again.</p>`;
                    console.error('Error fetching bookings:', error);
                }
            }
            
            async function fetchAvailability() {
                try {
                    availabilityData = await fetchWithAuth(`${API_BASE_URL}/api/admin/availability`);
                } catch (error) {
                    console.error('Error fetching availability overrides:', error);
                }
            }


            // --- RENDERING ---
            function renderBookings(bookingsByDate) {
                if (Object.keys(bookingsByDate).length === 0) {
                    bookingsListEl.innerHTML = '<p class="text-slate-500">No pickups have been scheduled yet.</p>';
                    return;
                }
                let html = '';
                const sortedDates = Object.keys(bookingsByDate).sort((a, b) => new Date(a) - new Date(b));
                for (const date of sortedDates) {
                    const bookings = bookingsByDate[date];
                    const formattedDate = new Date(date+'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    html += `<div class="bg-white/80 p-4 rounded-lg border"><h3 class="font-bold text-lg border-b pb-2 mb-3">${formattedDate}</h3><div class="space-y-4">`;
                    bookings.forEach(booking => {
                        html += `<div class="text-sm"><p class="font-bold text-base text-[#D97706]">${booking.time}</p><p><span class="font-semibold">Name:</span> ${booking.name}</p><p><span class="font-semibold">Email:</span> <a href="mailto:${booking.email}" class="text-blue-600 hover:underline">${booking.email}</a></p><p><span class="font-semibold">Address:</span> ${booking.address}</p>${booking.notes ? `<p><span class="font-semibold">Notes:</span> ${booking.notes}</p>` : ''}</div>`;
                    });
                    html += `</div></div>`;
                }
                bookingsListEl.innerHTML = html;
            }

            function renderCalendar() {
                calendarGridEl.innerHTML = `<div class="font-bold text-xs text-slate-500">S</div><div class="font-bold text-xs text-slate-500">M</div><div class="font-bold text-xs text-slate-500">T</div><div class="font-bold text-xs text-slate-500">W</div><div class="font-bold text-xs text-slate-500">T</div><div class="font-bold text-xs text-slate-500">F</div><div class="font-bold text-xs text-slate-500">S</div>`;
                const month = currentDate.getMonth();
                const year = currentDate.getFullYear();
                monthYearEl.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDayOfMonth; i++) { calendarGridEl.insertAdjacentHTML('beforeend', '<div></div>'); }
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayDate = new Date(year, month, day);
                    let classes = 'calendar-day cursor-pointer rounded-full p-2 transition-colors hover:bg-gray-200';
                    if (selectedDate && dayDate.toDateString() === selectedDate.toDateString()) { classes += ' selected'; }
                    const dayEl = `<div class="${classes}" data-date="${dayDate.toISOString().split('T')[0]}">${day}</div>`;
                    calendarGridEl.insertAdjacentHTML('beforeend', dayEl);
                }
            }
            
            function renderAvailabilityEditor() {
                availabilityEditorEl.classList.remove('hidden');
                const dateString = selectedDate.toISOString().split('T')[0];
                editingDateEl.textContent = selectedDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
                const standardSlots = ["08:00 AM - 09:00 AM", "09:00 AM - 10:00 AM", "10:00 AM - 11:00 AM"];
                const dayOfWeek = selectedDate.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                let checkboxesHtml = '';
                if(isWeekend) {
                     checkboxesHtml = `<p class="text-sm text-slate-500">Pickups are not available on weekends.</p>`;
                } else {
                    const dayOverrides = availabilityData[dateString] || {};
                    standardSlots.forEach(slot => {
                        const isAvailable = dayOverrides[slot] !== false;
                        checkboxesHtml += `<label class="flex items-center space-x-2"><input type="checkbox" data-slot="${slot}" class="rounded" ${isAvailable ? 'checked' : ''}><span>${slot}</span></label>`;
                    });
                }
                timeSlotsCheckboxesEl.innerHTML = checkboxesHtml;
            }

            // --- EVENT LISTENERS ---
            prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
            nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
            logoutBtn.addEventListener('click', () => {
                sessionStorage.removeItem('erthaware-admin-token');
                window.location.href = './login.html';
            });

            calendarGridEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('calendar-day') && e.target.dataset.date) {
                    selectedDate = new Date(e.target.dataset.date + 'T00:00:00');
                    renderCalendar();
                    renderAvailabilityEditor();
                }
            });

            saveAvailabilityBtn.addEventListener('click', async () => {
                const date = selectedDate.toISOString().split('T')[0];
                const slots = {};
                const checkboxes = timeSlotsCheckboxesEl.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => { slots[cb.dataset.slot] = cb.checked; });
                try {
                    await fetchWithAuth(`${API_BASE_URL}/api/admin/availability`, {
                        method: 'POST',
                        body: JSON.stringify({ date, slots })
                    });
                    await fetchAvailability();
                    alert('Availability updated successfully!');
                } catch(error) {
                    alert(`Error: ${error.message}`);
                    console.error('Failed to save availability', error);
                }
            });

            // --- INITIALIZATION ---
            async function initialize() {
                await fetchAvailability();
                await fetchBookings();
                renderCalendar();
            }
            initialize();
        });
    </script>
</body>
</html>

